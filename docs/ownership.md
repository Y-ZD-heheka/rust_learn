# æ‰€æœ‰æƒç³»ç»Ÿæ¨¡å— (ownership)

## ğŸ“– æ¨¡å—æ¦‚è¿°

æ‰€æœ‰æƒæ˜¯ Rust æœ€æ ¸å¿ƒçš„ç‰¹æ€§ï¼Œä¹Ÿæ˜¯ Rust èƒ½å¤Ÿä¿è¯å†…å­˜å®‰å…¨çš„å…³é”®æœºåˆ¶ã€‚æœ¬æ¨¡å—æ·±å…¥è®²è§£æ‰€æœ‰æƒã€å€Ÿç”¨å’Œç”Ÿå‘½å‘¨æœŸçš„æ¦‚å¿µï¼Œå¸®åŠ©å­¦ä¹ è€…ç†è§£ Rust çš„å†…å­˜ç®¡ç†æ¨¡å‹ã€‚

## ğŸ¯ å­¦ä¹ ç›®æ ‡

- æ·±å…¥ç†è§£æ‰€æœ‰æƒã€å€Ÿç”¨å’Œå¼•ç”¨çš„æ¦‚å¿µ
- æŒæ¡ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨å’Œä½¿ç”¨
- ç†è§£æ™ºèƒ½æŒ‡é’ˆçš„ä½¿ç”¨åœºæ™¯
- å­¦ä¼šå¤„ç†å¤æ‚çš„æ‰€æœ‰æƒåœºæ™¯
- æŒæ¡å€Ÿç”¨æ£€æŸ¥å™¨çš„å·¥ä½œåŸç†

## ğŸ“š å†…å®¹ç›®å½•

### 1. æ‰€æœ‰æƒåŸºç¡€ (`ownership_basics`)

```rust
// æ‰€æœ‰æƒè½¬ç§»
let s1 = String::from("hello");
let s2 = s1;  // s1 çš„æ‰€æœ‰æƒè½¬ç§»ç»™ s2
// println!("{}", s1);  // ç¼–è¯‘é”™è¯¯ï¼s1 ä¸å†æœ‰æ•ˆ

// å…‹éš†ï¼ˆæ·±æ‹·è´ï¼‰
let s3 = s2.clone();  // s2 ä»ç„¶æœ‰æ•ˆ
println!("s2: {}, s3: {}", s2, s3);
```

**æ ¸å¿ƒè§„åˆ™**ï¼š
- æ¯ä¸ª Rust å€¼éƒ½æœ‰ä¸€ä¸ªæ‰€æœ‰è€…
- åŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªæ‰€æœ‰è€…
- å½“æ‰€æœ‰è€…ç¦»å¼€ä½œç”¨åŸŸï¼Œå€¼å°†è¢«ä¸¢å¼ƒ

### 2. å€Ÿç”¨å’Œå¼•ç”¨ (`borrowing`)

```rust
// ä¸å¯å˜å€Ÿç”¨
fn calculate_length(s: &String) -> usize {
    s.len()
}

let s = String::from("hello");
let len = calculate_length(&s);
println!("{} çš„é•¿åº¦æ˜¯ {}", s, len);  // s ä»ç„¶æœ‰æ•ˆ

// å¯å˜å€Ÿç”¨
fn change(s: &mut String) {
    s.push_str(", world");
}

let mut s = String::from("hello");
change(&mut s);
println!("{}", s);  // "hello, world"
```

**å€Ÿç”¨è§„åˆ™**ï¼š
- å¯ä»¥æœ‰å¤šä¸ªä¸å¯å˜å¼•ç”¨
- æˆ–è€…ä¸€ä¸ªå¯å˜å¼•ç”¨
- ä½†ä¸èƒ½åŒæ—¶å­˜åœ¨å¯å˜å’Œä¸å¯å˜å¼•ç”¨

### 3. åˆ‡ç‰‡æ“ä½œ (`slices`)

```rust
// å­—ç¬¦ä¸²åˆ‡ç‰‡
let s = String::from("hello world");
let hello = &s[0..5];   // "hello"
let world = &s[6..11];  // "world"

// æ•°ç»„åˆ‡ç‰‡
let arr = [1, 2, 3, 4, 5];
let slice = &arr[1..3];  // [2, 3]
```

### 4. ç”Ÿå‘½å‘¨æœŸ (`advanced_lifetimes`)

```rust
// ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨
fn longest<'a>(x: &'a str, y: &'a str) -> &'a str {
    if x.len() > y.len() { x } else { y }
}

// ç»“æ„ä½“ä¸­çš„ç”Ÿå‘½å‘¨æœŸ
struct Parser<'a> {
    text: &'a str,
    position: usize,
}

impl<'a> Parser<'a> {
    fn parse_word(&mut self) -> Option<&'a str> {
        // è¿”å›çš„ç”Ÿå‘½å‘¨æœŸä¸ text ç›¸åŒ
        // ...
    }
}
```

### 5. æ™ºèƒ½æŒ‡é’ˆ (`modern_pointers`)

```rust
use std::rc::Rc;
use std::sync::{Arc, Mutex};

// Box - å †åˆ†é…
let boxed = Box::new(42);

// Rc - å¼•ç”¨è®¡æ•°ï¼ˆå•çº¿ç¨‹ï¼‰
let shared = Rc::new(vec![1, 2, 3]);
let clone1 = Rc::clone(&shared);
let clone2 = Rc::clone(&shared);

// Arc - åŸå­å¼•ç”¨è®¡æ•°ï¼ˆå¤šçº¿ç¨‹ï¼‰
let shared_thread = Arc::new(Mutex::new(0));
```

### 6. å¤æ‚æ‰€æœ‰æƒåœºæ™¯ (`complex_ownership_scenarios`)

```rust
// æ–‡ä»¶å¥æŸ„ç®¡ç†
struct FileHandle {
    filename: String,
    content: Option<String>,
}

impl FileHandle {
    fn read_content(&mut self) -> Result<&str, String> {
        // å€Ÿç”¨å’Œæ‰€æœ‰æƒäº¤äº’
    }
}

// å›¾ä¹¦ç®¡ç†ç³»ç»Ÿ
struct Library {
    books: Vec<Book>,
}

impl Library {
    fn add_book(&mut self, book: Book) {
        // æ‰€æœ‰æƒè½¬ç§»
    }
    
    fn find_book(&self, isbn: &str) -> Option<&Book> {
        // è¿”å›å€Ÿç”¨
    }
}
```

### 7. é«˜çº§æ™ºèƒ½æŒ‡é’ˆ (`advanced_smart_pointers`)

```rust
// è‡ªå®šä¹‰æ™ºèƒ½æŒ‡é’ˆ
struct CustomBox<T> {
    data: Box<T>,
}

impl<T> CustomBox<T> {
    fn new(data: T) -> Self {
        Self { data: Box::new(data) }
    }
    
    fn get_ref(&self) -> &T {
        &self.data
    }
}

// å†…éƒ¨å¯å˜æ€§æ¨¡å¼
use std::cell::RefCell;

let data = RefCell::new(5);
*data.borrow_mut() += 1;  // é€šè¿‡ä¸å¯å˜å¼•ç”¨ä¿®æ”¹
```

### 8. å€Ÿç”¨æ£€æŸ¥å™¨åº”ç”¨ (`borrowing_checker_applications`)

```rust
// å¸¸è§å€Ÿç”¨é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ
let mut data = vec![1, 2, 3];

// âŒ é”™è¯¯ï¼šåŒæ—¶å­˜åœ¨å¯å˜å’Œä¸å¯å˜å€Ÿç”¨
// let first = &data[0];
// data.push(4);  // ç¼–è¯‘é”™è¯¯

// âœ… æ­£ç¡®ï¼šå…ˆä½¿ç”¨å€¼ï¼Œå†ä¿®æ”¹
let first = data[0];
data.push(4);
```

## ğŸš€ è¿è¡Œç¤ºä¾‹

```bash
# è¿è¡Œæ‰€æœ‰æƒæ¨¡å—
cargo run ownership

# è¿è¡Œå¤æ‚æ‰€æœ‰æƒåœºæ™¯
cargo run ownership --features complex
```

## ğŸ“Š æ‰€æœ‰æƒè½¬ç§»å›¾è§£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ‰€æœ‰æƒè§„åˆ™                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚   Stack                     Heap                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚   â”‚ s1      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ "hello" (æ•°æ®)     â”‚       â”‚
â”‚   â”‚ ptr     â”‚              â”‚ len: 5            â”‚       â”‚
â”‚   â”‚ len: 5  â”‚              â”‚ capacity: 5       â”‚       â”‚
â”‚   â”‚ cap: 5  â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚                                                        â”‚
â”‚   let s2 = s1;  // æ‰€æœ‰æƒè½¬ç§»                          â”‚
â”‚                                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚   â”‚ s1      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚ "hello" (æ•°æ®)     â”‚       â”‚
â”‚   â”‚ (æ— æ•ˆ)  â”‚         â”‚    â”‚ len: 5            â”‚       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚    â”‚ capacity: 5       â”‚       â”‚
â”‚                       â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚              â–²                â”‚
â”‚   â”‚ s2      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚                â”‚
â”‚   â”‚ ptr     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚   â”‚ len: 5  â”‚                                          â”‚
â”‚   â”‚ cap: 5  â”‚                                          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ ç»ƒä¹ é¢˜

### åˆçº§
1. è§£é‡Šä»¥ä¸‹ä»£ç ä¸ºä»€ä¹ˆç¼–è¯‘å¤±è´¥ï¼š
   ```rust
   let s1 = String::from("hello");
   let s2 = s1;
   println!("{}", s1);
   ```

2. ä¿®å¤ä»¥ä¸‹ä»£ç ï¼š
   ```rust
   fn main() {
       let s = String::from("hello");
       let len = calculate_length(s);
       println!("{} çš„é•¿åº¦æ˜¯ {}", s, len);
   }
   
   fn calculate_length(s: String) -> usize {
       s.len()
   }
   ```

### ä¸­çº§
1. å®ç°ä¸€ä¸ªå‡½æ•°ï¼Œäº¤æ¢ä¸¤ä¸ªå­—ç¬¦ä¸²çš„å€¼
2. ç¼–å†™ä¸€ä¸ªç»“æ„ä½“ï¼ŒåŒ…å«ä¸€ä¸ªå­—ç¬¦ä¸²åˆ‡ç‰‡å­—æ®µï¼Œå¹¶å®ç°ä¸€ä¸ªæ–¹æ³•è¿”å›è¯¥åˆ‡ç‰‡
3. è§£é‡Šä¸ºä»€ä¹ˆä»¥ä¸‹ä»£ç ä¼šç¼–è¯‘å¤±è´¥ï¼š
   ```rust
   fn main() {
       let mut s = String::from("hello");
       let r1 = &s;
       let r2 = &mut s;
       println!("{} {}", r1, r2);
   }
   ```

### é«˜çº§
1. å®ç°ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œä½¿ç”¨ `Rc<RefCell<Node>>`
2. å®ç°ä¸€ä¸ªç®€å•çš„å¼•ç”¨è®¡æ•°æ™ºèƒ½æŒ‡é’ˆ
3. è®¾è®¡ä¸€ä¸ªç±»å‹å®‰å…¨çš„èµ„æºç®¡ç†å™¨ï¼Œä½¿ç”¨ç±»å‹çŠ¶æ€æ¨¡å¼

## ğŸ”— ç›¸å…³èµ„æº

- [Rust æ‰€æœ‰æƒå®˜æ–¹æ–‡æ¡£](https://doc.rust-lang.org/book/ch04-00-understanding-ownership.html)
- [Rust å€Ÿç”¨æ£€æŸ¥å™¨](https://blog.rust-lang.org/2018/08/07/Rust-1.28.html#the-borrow-checker)
- [Rust ç”Ÿå‘½å‘¨æœŸ](https://doc.rust-lang.org/book/ch10-03-lifetime-syntax.html)

## âš ï¸ å¸¸è§é™·é˜±

### 1. æ‚¬å‚å¼•ç”¨
```rust
// âŒ é”™è¯¯ï¼šè¿”å›å±€éƒ¨å˜é‡çš„å¼•ç”¨
fn dangle() -> &String {
    let s = String::from("hello");
    &s  // s åœ¨å‡½æ•°ç»“æŸæ—¶è¢«ä¸¢å¼ƒ
}

// âœ… æ­£ç¡®ï¼šè½¬ç§»æ‰€æœ‰æƒ
fn no_dangle() -> String {
    let s = String::from("hello");
    s
}
```

### 2. å¯å˜å€Ÿç”¨å†²çª
```rust
// âŒ é”™è¯¯
let mut v = vec![1, 2, 3];
let first = &v[0];      // ä¸å¯å˜å€Ÿç”¨
v.push(4);              // å¯å˜å€Ÿç”¨ - å†²çªï¼

// âœ… æ­£ç¡®
let mut v = vec![1, 2, 3];
let first = v[0];       // å¤åˆ¶å€¼
v.push(4);              // ç°åœ¨å¯ä»¥ä¿®æ”¹
```

### 3. ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨é”™è¯¯
```rust
// âŒ é”™è¯¯ï¼šç”Ÿå‘½å‘¨æœŸä¸åŒ¹é…
fn longest(x: &str, y: &str) -> &str {
    // ç¼–è¯‘å™¨æ— æ³•ç¡®å®šè¿”å›å€¼çš„ç”Ÿå‘½å‘¨æœŸ
}

// âœ… æ­£ç¡®ï¼šæ·»åŠ ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨
fn longest<'a>(x: &'a str, y: &'a str) -> &'a str {
    if x.len() > y.len() { x } else { y }
}
```

## ğŸ“Š å­¦ä¹ æ£€æŸ¥æ¸…å•

- [ ] ç†è§£æ‰€æœ‰æƒçš„ä¸‰ä¸ªè§„åˆ™
- [ ] æŒæ¡å€Ÿç”¨å’Œå¼•ç”¨çš„åŒºåˆ«
- [ ] ç†è§£å¯å˜å’Œä¸å¯å˜å¼•ç”¨çš„è§„åˆ™
- [ ] ä¼šä½¿ç”¨åˆ‡ç‰‡ç±»å‹
- [ ] ç†è§£ç”Ÿå‘½å‘¨æœŸçš„æ¦‚å¿µ
- [ ] ä¼šæ ‡æ³¨ç”Ÿå‘½å‘¨æœŸå‚æ•°
- [ ] æŒæ¡ Boxã€Rcã€Arc çš„ä½¿ç”¨
- [ ] ç†è§£å†…éƒ¨å¯å˜æ€§æ¨¡å¼
- [ ] èƒ½å¤Ÿè§£å†³å¤æ‚çš„æ‰€æœ‰æƒé—®é¢˜
