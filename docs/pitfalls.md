# å¸¸è§é™·é˜±æ¨¡å— (pitfalls)

## ğŸ“– æ¨¡å—æ¦‚è¿°

Rust è™½ç„¶æœ‰å¼ºå¤§çš„ç¼–è¯‘å™¨ä¿æŠ¤ï¼Œä½†ä»æœ‰ä¸€äº›å¸¸è§çš„é™·é˜±å’Œè¯¯åŒºã€‚æœ¬æ¨¡å—æ€»ç»“ Rust ç¼–ç¨‹ä¸­å®¹æ˜“çŠ¯çš„é”™è¯¯ï¼Œå¸®åŠ©å¼€å‘è€…é¿å…è¿™äº›é—®é¢˜ã€‚

## ğŸ¯ å­¦ä¹ ç›®æ ‡

- ç†è§£æ‰€æœ‰æƒç›¸å…³çš„å¸¸è§é™·é˜±
- æŒæ¡å€Ÿç”¨æ£€æŸ¥å™¨çš„é™åˆ¶
- å­¦ä¼šé¿å…ç”Ÿå‘½å‘¨æœŸé—®é¢˜
- ç†è§£ç±»å‹ç³»ç»Ÿçš„é™·é˜±
- æŒæ¡å¹¶å‘ç¼–ç¨‹çš„æ³¨æ„äº‹é¡¹

## ğŸ“š å†…å®¹ç›®å½•

### 1. æ‰€æœ‰æƒé™·é˜±

#### 1.1 æ„å¤–çš„æ‰€æœ‰æƒè½¬ç§»

```rust
// âŒ é™·é˜±ï¼šæ„å¤–çš„æ‰€æœ‰æƒè½¬ç§»
let v = vec![1, 2, 3];
let v2 = v;  // v çš„æ‰€æœ‰æƒå·²è½¬ç§»
// println!("{:?}", v);  // ç¼–è¯‘é”™è¯¯ï¼

// âœ… è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨å…‹éš†æˆ–å¼•ç”¨
let v = vec![1, 2, 3];
let v2 = v.clone();  // æˆ–ä½¿ç”¨ &v
println!("{:?}", v);  // æ­£å¸¸å·¥ä½œ
```

#### 1.2 å¾ªç¯ä¸­çš„æ‰€æœ‰æƒé—®é¢˜

```rust
// âŒ é™·é˜±ï¼šå¾ªç¯ä¸­æ¶ˆè€—å€¼
let data = vec![String::from("hello"), String::from("world")];
for s in data {  // data è¢«æ¶ˆè€—
    println!("{}", s);
}
// println!("{:?}", data);  // ç¼–è¯‘é”™è¯¯ï¼

// âœ… è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨å¼•ç”¨
let data = vec![String::from("hello"), String::from("world")];
for s in &data {  // å€Ÿç”¨
    println!("{}", s);
}
println!("{:?}", data);  // æ­£å¸¸å·¥ä½œ
```

### 2. å€Ÿç”¨é™·é˜±

#### 2.1 å¯å˜ä¸ä¸å¯å˜å€Ÿç”¨å†²çª

```rust
// âŒ é™·é˜±ï¼šåŒæ—¶å­˜åœ¨å¯å˜å’Œä¸å¯å˜å€Ÿç”¨
let mut v = vec![1, 2, 3];
let first = &v[0];  // ä¸å¯å˜å€Ÿç”¨
v.push(4);          // å¯å˜å€Ÿç”¨ - ç¼–è¯‘é”™è¯¯ï¼
println!("{}", first);

// âœ… è§£å†³æ–¹æ¡ˆï¼šåˆ†ç¦»å€Ÿç”¨ä½œç”¨åŸŸ
let mut v = vec![1, 2, 3];
let first = v[0];   // å¤åˆ¶å€¼
v.push(4);          // ç°åœ¨å¯ä»¥ä¿®æ”¹
println!("{}", first);
```

#### 2.2 å€Ÿç”¨ç”Ÿå‘½å‘¨æœŸé—®é¢˜

```rust
// âŒ é™·é˜±ï¼šè¿”å›å±€éƒ¨å˜é‡çš„å¼•ç”¨
fn get_item() -> &String {
    let s = String::from("hello");
    &s  // è¿”å›å±€éƒ¨å˜é‡çš„å¼•ç”¨ - ç¼–è¯‘é”™è¯¯ï¼
}

// âœ… è§£å†³æ–¹æ¡ˆï¼šè¿”å›æ‰€æœ‰æƒ
fn get_item() -> String {
    let s = String::from("hello");
    s
}
```

### 3. ç”Ÿå‘½å‘¨æœŸé™·é˜±

#### 3.1 ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨ä¸è¶³

```rust
// âŒ é™·é˜±ï¼šç¼ºå°‘ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨
fn longest(x: &str, y: &str) -> &str {  // ç¼–è¯‘é”™è¯¯ï¼
    if x.len() > y.len() { x } else { y }
}

// âœ… è§£å†³æ–¹æ¡ˆï¼šæ·»åŠ ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨
fn longest<'a>(x: &'a str, y: &'a str) -> &'a str {
    if x.len() > y.len() { x } else { y }
}
```

#### 3.2 ç»“æ„ä½“ç”Ÿå‘½å‘¨æœŸ

```rust
// âŒ é™·é˜±ï¼šç»“æ„ä½“ç¼ºå°‘ç”Ÿå‘½å‘¨æœŸ
struct Parser {
    text: &str,  // ç¼–è¯‘é”™è¯¯ï¼
}

// âœ… è§£å†³æ–¹æ¡ˆï¼šæ·»åŠ ç”Ÿå‘½å‘¨æœŸå‚æ•°
struct Parser<'a> {
    text: &'a str,
}

impl<'a> Parser<'a> {
    fn parse(&self) -> &'a str {
        self.text
    }
}
```

### 4. ç±»å‹ç³»ç»Ÿé™·é˜±

#### 4.1 æ•´æ•°æº¢å‡º

```rust
// âŒ é™·é˜±ï¼šdebug æ¨¡å¼ä¼š panicï¼Œrelease æ¨¡å¼ä¼šå›ç»•
let x: u8 = 255;
let y = x + 1;  // debug: panic, release: 0

// âœ… è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨æ£€æŸ¥æ–¹æ³•
let x: u8 = 255;
let y = x.checked_add(1).unwrap_or(u8::MAX);  // å®‰å…¨å¤„ç†
```

#### 4.2 æµ®ç‚¹æ•°æ¯”è¾ƒ

```rust
// âŒ é™·é˜±ï¼šç›´æ¥æ¯”è¾ƒæµ®ç‚¹æ•°
let a = 0.1 + 0.2;
let b = 0.3;
if a == b {  // false!
    println!("ç›¸ç­‰");
}

// âœ… è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨è¿‘ä¼¼æ¯”è¾ƒ
if (a - b).abs() < f64::EPSILON {
    println!("è¿‘ä¼¼ç›¸ç­‰");
}
```

#### 4.3 ç±»å‹æ¨æ–­é—®é¢˜

```rust
// âŒ é™·é˜±ï¼šç±»å‹æ¨æ–­å¤±è´¥
let v = vec![];  // ç±»å‹æœªçŸ¥
// v.push(1);  // ç¼–è¯‘é”™è¯¯ï¼

// âœ… è§£å†³æ–¹æ¡ˆï¼šæ˜¾å¼ç±»å‹æ ‡æ³¨
let v: Vec<i32> = vec![];
v.push(1);
```

### 5. è¿­ä»£å™¨é™·é˜±

#### 5.1 è¿­ä»£å™¨æ¶ˆè€—

```rust
// âŒ é™·é˜±ï¼šè¿­ä»£å™¨è¢«æ¶ˆè€—
let v = vec![1, 2, 3];
let sum: i32 = v.iter().sum();
// let count = v.iter().count();  // å¯ä»¥å†æ¬¡è¿­ä»£

let v = vec![1, 2, 3];
let iter = v.iter();
let sum: i32 = iter.clone().sum();  // å…‹éš†è¿­ä»£å™¨
let count = iter.count();  // åŸè¿­ä»£å™¨è¢«æ¶ˆè€—
```

#### 5.2 è¿­ä»£å™¨ä¿®æ”¹é›†åˆ

```rust
// âŒ é™·é˜±ï¼šè¿­ä»£æ—¶ä¿®æ”¹é›†åˆ
let mut v = vec![1, 2, 3];
for i in &v {
    // v.push(4);  // ç¼–è¯‘é”™è¯¯ï¼
}

// âœ… è§£å†³æ–¹æ¡ˆï¼šæ”¶é›†è¦ä¿®æ”¹çš„å†…å®¹
let mut v = vec![1, 2, 3];
let to_add: Vec<i32> = v.iter().map(|&x| x * 2).collect();
v.extend(to_add);
```

### 6. æ™ºèƒ½æŒ‡é’ˆé™·é˜±

#### 6.1 å¾ªç¯å¼•ç”¨

```rust
// âŒ é™·é˜±ï¼šRc å¾ªç¯å¼•ç”¨å¯¼è‡´å†…å­˜æ³„æ¼
use std::rc::Rc;
use std::cell::RefCell;

struct Node {
    next: RefCell<Option<Rc<Node>>>,
}

let a = Rc::new(Node { next: RefCell::new(None) });
let b = Rc::new(Node { next: RefCell::new(None) });

*a.next.borrow_mut() = Some(b.clone());
*b.next.borrow_mut() = Some(a.clone());  // å¾ªç¯å¼•ç”¨ï¼

// âœ… è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ Weak æ‰“ç ´å¾ªç¯
use std::rc::Weak;

struct SafeNode {
    next: RefCell<Option<Weak<SafeNode>>>,
}
```

#### 6.2 RefCell è¿è¡Œæ—¶å€Ÿç”¨æ£€æŸ¥

```rust
// âŒ é™·é˜±ï¼šè¿è¡Œæ—¶å€Ÿç”¨æ£€æŸ¥å¤±è´¥
use std::cell::RefCell;

let data = RefCell::new(5);
let r1 = data.borrow();
let r2 = data.borrow_mut();  // panic! å·²æœ‰ä¸å¯å˜å€Ÿç”¨

// âœ… è§£å†³æ–¹æ¡ˆï¼šç¡®ä¿å€Ÿç”¨ä½œç”¨åŸŸæ­£ç¡®
let data = RefCell::new(5);
{
    let r1 = data.borrow();
    // ä½¿ç”¨ r1
}  // r1 è¢«é‡Šæ”¾
let r2 = data.borrow_mut();  // ç°åœ¨å¯ä»¥
```

### 7. å¹¶å‘é™·é˜±

#### 7.1 æ­»é”

```rust
// âŒ é™·é˜±ï¼šæ­»é”
use std::sync::Mutex;

let data1 = Mutex::new(1);
let data2 = Mutex::new(2);

// çº¿ç¨‹1
let _g1 = data1.lock().unwrap();
let _g2 = data2.lock().unwrap();  // å¯èƒ½æ­»é”

// çº¿ç¨‹2ï¼ˆåŒæ—¶ï¼‰
let _g2 = data2.lock().unwrap();
let _g1 = data1.lock().unwrap();  // æ­»é”ï¼

// âœ… è§£å†³æ–¹æ¡ˆï¼šç»Ÿä¸€é”é¡ºåº
// å§‹ç»ˆæŒ‰ç›¸åŒé¡ºåºè·å–é”
```

#### 7.2 æ•°æ®ç«äº‰

```rust
// âŒ é™·é˜±ï¼šRust é˜»æ­¢çš„æ•°æ®ç«äº‰
let mut data = vec![1, 2, 3];
let ref1 = &data[0];
let ref2 = &mut data;  // ç¼–è¯‘é”™è¯¯ï¼

// âœ… è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ Mutex ä¿æŠ¤
use std::sync::{Arc, Mutex};

let data = Arc::new(Mutex::new(vec![1, 2, 3]));
let data_clone = Arc::clone(&data);
thread::spawn(move || {
    data_clone.lock().unwrap().push(4);
});
```

### 8. é”™è¯¯å¤„ç†é™·é˜±

#### 8.1 unwrap æ»¥ç”¨

```rust
// âŒ é™·é˜±ï¼šç”Ÿäº§ä»£ç ä¸­ä½¿ç”¨ unwrap
fn read_config() -> Config {
    let content = std::fs::read_to_string("config.toml").unwrap();  // å¯èƒ½ panic!
    toml::from_str(&content).unwrap()  // å¯èƒ½ panic!
}

// âœ… è§£å†³æ–¹æ¡ˆï¼šæ­£ç¡®å¤„ç†é”™è¯¯
fn read_config() -> Result<Config, Error> {
    let content = std::fs::read_to_string("config.toml")
        .context("æ— æ³•è¯»å–é…ç½®æ–‡ä»¶")?;
    toml::from_str(&content)
        .context("é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯")
}
```

#### 8.2 å¿½ç•¥é”™è¯¯

```rust
// âŒ é™·é˜±ï¼šå¿½ç•¥é”™è¯¯
let _ = file.write_all(data);  // é”™è¯¯è¢«å¿½ç•¥

// âœ… è§£å†³æ–¹æ¡ˆï¼šå¤„ç†æˆ–ä¼ æ’­é”™è¯¯
file.write_all(data)?;
// æˆ–
if let Err(e) = file.write_all(data) {
    log::error!("å†™å…¥å¤±è´¥: {}", e);
}
```

## ğŸš€ è¿è¡Œç¤ºä¾‹

```bash
# è¿è¡Œé™·é˜±æ¨¡å—
cargo run pitfalls

# è¿è¡Œ clippy æ£€æŸ¥æ½œåœ¨é—®é¢˜
cargo clippy -- -W warnings
```

## ğŸ“Š é™·é˜±åˆ†ç±»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Rust å¸¸è§é™·é˜±                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  æ‰€æœ‰æƒé™·é˜±  â”‚  â”‚  å€Ÿç”¨é™·é˜±   â”‚  â”‚ ç”Ÿå‘½å‘¨æœŸé™·é˜± â”‚         â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”‚
â”‚  â”‚ â€¢ æ„å¤–è½¬ç§»  â”‚  â”‚ â€¢ å€Ÿç”¨å†²çª  â”‚  â”‚ â€¢ æ ‡æ³¨ä¸è¶³  â”‚         â”‚
â”‚  â”‚ â€¢ å¾ªç¯æ¶ˆè€—  â”‚  â”‚ â€¢ ç”Ÿå‘½å‘¨æœŸ  â”‚  â”‚ â€¢ ç»“æ„ä½“    â”‚         â”‚
â”‚  â”‚ â€¢ é—­åŒ…æ•è·  â”‚  â”‚ â€¢ æ‚¬å‚å¼•ç”¨  â”‚  â”‚ â€¢ é—­åŒ…      â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  ç±»å‹é™·é˜±   â”‚  â”‚ è¿­ä»£å™¨é™·é˜±  â”‚  â”‚  å¹¶å‘é™·é˜±   â”‚         â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”‚
â”‚  â”‚ â€¢ æ•´æ•°æº¢å‡º  â”‚  â”‚ â€¢ è¿­ä»£å™¨æ¶ˆè€—â”‚  â”‚ â€¢ æ­»é”      â”‚         â”‚
â”‚  â”‚ â€¢ æµ®ç‚¹æ¯”è¾ƒ  â”‚  â”‚ â€¢ ä¿®æ”¹é›†åˆ  â”‚  â”‚ â€¢ æ•°æ®ç«äº‰  â”‚         â”‚
â”‚  â”‚ â€¢ ç±»å‹æ¨æ–­  â”‚  â”‚ â€¢ æƒ°æ€§æ±‚å€¼  â”‚  â”‚ â€¢ å¾ªç¯å¼•ç”¨  â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ ç»ƒä¹ é¢˜

### åˆçº§
1. ä¿®å¤ä»¥ä¸‹ä»£ç çš„æ‰€æœ‰æƒé—®é¢˜
2. è¯†åˆ«å¹¶ä¿®å¤å€Ÿç”¨å†²çª
3. æ·»åŠ æ­£ç¡®çš„ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨

### ä¸­çº§
1. é‡æ„ä»£ç é¿å…å¾ªç¯å¼•ç”¨
2. ä¿®å¤å¹¶å‘ä»£ç ä¸­çš„æ½œåœ¨æ­»é”
3. æ”¹è¿›é”™è¯¯å¤„ç†é¿å… panic

### é«˜çº§
1. è®¾è®¡ä¸€ä¸ªé¿å…å¸¸è§é™·é˜±çš„ API
2. å®ç°ä¸€ä¸ªå®‰å…¨çš„è¿­ä»£å™¨é€‚é…å™¨
3. ç¼–å†™ä¸€ä¸ªæ— æ­»é”çš„å¹¶å‘æ•°æ®ç»“æ„

## ğŸ”— ç›¸å…³èµ„æº

- [Rust å¸¸è§é™·é˜±](https://rust-unofficial.github.io/rust-trap/)
- [Rust å€Ÿç”¨æ£€æŸ¥å™¨](https://blog.rust-lang.org/2018/08/07/Rust-1.28.html)
- [Effective Rust](https://www.lurklurk.org/effective-rust/)

## âš ï¸ è°ƒè¯•æŠ€å·§

### 1. ä½¿ç”¨ç¼–è¯‘å™¨æç¤º
```rust
// Rust ç¼–è¯‘å™¨é€šå¸¸æä¾›è¯¦ç»†çš„é”™è¯¯æç¤º
// ä»”ç»†é˜…è¯»ç¼–è¯‘å™¨å»ºè®®
```

### 2. ä½¿ç”¨ clippy
```bash
cargo clippy -- -W warnings
```

### 3. ä½¿ç”¨ miri æ£€æµ‹æœªå®šä¹‰è¡Œä¸º
```bash
cargo miri test
```

### 4. ä½¿ç”¨ RAII æ¨¡å¼
```rust
// åˆ©ç”¨ Rust çš„ RAII ç‰¹æ€§è‡ªåŠ¨ç®¡ç†èµ„æº
{
    let _guard = MutexGuard::lock(&mutex);
    // è‡ªåŠ¨é‡Šæ”¾
}
```

## ğŸ“Š å­¦ä¹ æ£€æŸ¥æ¸…å•

- [ ] ç†è§£æ‰€æœ‰æƒè½¬ç§»è§„åˆ™
- [ ] æŒæ¡å€Ÿç”¨è§„åˆ™
- [ ] ä¼šæ­£ç¡®æ ‡æ³¨ç”Ÿå‘½å‘¨æœŸ
- [ ] ç†è§£æ•´æ•°æº¢å‡ºé—®é¢˜
- [ ] æŒæ¡æµ®ç‚¹æ•°æ¯”è¾ƒæ–¹æ³•
- [ ] ç†è§£è¿­ä»£å™¨æ¶ˆè€—
- [ ] ä¼šé¿å…å¾ªç¯å¼•ç”¨
- [ ] æŒæ¡å¹¶å‘å®‰å…¨
- [ ] ä¼šæ­£ç¡®å¤„ç†é”™è¯¯
